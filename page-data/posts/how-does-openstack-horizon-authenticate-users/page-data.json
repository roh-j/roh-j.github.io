{"componentChunkName":"component---src-templates-post-template-jsx","path":"/posts/how-does-openstack-horizon-authenticate-users/","result":{"data":{"site":{"siteMetadata":{"title":"Roh-j's Blog","subtitle":"안녕하세요! 노재희입니다.","copyright":"© roh-j. All rights reserved.","author":{"name":"Roh Jaehee","github":"roh-j"},"disqusShortname":"","url":"https://roh-j.github.io"}},"markdownRemark":{"id":"3b008a33-56f0-5fcc-aba5-6a97718588fc","html":"<p>Horizon은 클라우드 관리자와 사용자들이 다양한 OpenStack 자원과 서비스를 관리할 수 있는 웹 인터페이스입니다. OpenStack Horizon은 어떻게 사용자를 인증, 인가하고 Keystone과 연동할까요? 이에 대한 과정을 시퀀스 다이어그램과 코드를 통해 알아봅시다.</p>\n<h1>OpenStack Horizon 인증 과정 요약</h1>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>과정</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1.　</td>\n<td>Horizon은 Django의 인증 로직을 커스터마이징하여 Keystone과 연동한다.</td>\n</tr>\n<tr>\n<td>2.　</td>\n<td>Keystone에서는 크게 2가지 유형의 토큰을 발급한다. (Unscoped 토큰, Scoped 토큰)</td>\n</tr>\n<tr>\n<td>3.　</td>\n<td>Unscoped 토큰은 Keystone이 인증된 사용자에 대해 발급하는 신분 증명용 토큰으로 Scoped 토큰을 발급받기 위해 사용된다.</td>\n</tr>\n<tr>\n<td>4.　</td>\n<td>Scoped 토큰을 발급받는 이유는 Unscoped 토큰만으로는 서비스(e.g. Nova)에 요청할 수 없기 때문이다.</td>\n</tr>\n<tr>\n<td>5.　</td>\n<td>Scoped 토큰은 클라이언트(e.g. 유저, Nova, Glance)가 실행할 수 있는 범위가 담겨있는 토큰으로 서비스(e.g. Nova)에 요청할 수 있다.</td>\n</tr>\n<tr>\n<td>6.　</td>\n<td>결국, Keystone 연동에서의 핵심은 Scoped 토큰을 발급받는 것이다.</td>\n</tr>\n<tr>\n<td>7.　</td>\n<td>사용자가 인증되면 Horizon은 Unscoped 토큰을 세션에 저장한다. (추후 Scoped 토큰을 발급 받기 위해)</td>\n</tr>\n<tr>\n<td>8.　</td>\n<td>세션에 저장된 Unscoped 토큰을 이용해 Scoped 토큰을 발급 받는다.</td>\n</tr>\n<tr>\n<td>9.　</td>\n<td>발급 받은 Scoped 토큰과 함께 서비스(e.g. Nova)에 요청한다.</td>\n</tr>\n</tbody>\n</table>\n<h1>사용자 로그인 (시퀀스 다이어그램)</h1>\n<p>Horizon은 Django 인증 시스템을 통해 사용자를 인증합니다. Keystone과 연동하기 위해 Custom 인증이 추가되어 있는데, 이를 <code class=\"language-text\">settings.py</code>의 <code class=\"language-text\">AUTHENTICATION_BACKENDS</code> 옵션을 통해 확인할 수 있습니다. Custom 인증의 핵심은 Keystone에서 Unscoped 토큰을 발급받는 것으로, <code class=\"language-text\">openstack_auth.backend.KeystoneBackend</code> 모듈에서 진행합니다. Unscoped 토큰이 성공적으로 발급되면 해당 토큰을 Django Session에 저장합니다.</p>\n<p>Unscoped 토큰:</p>\n<ul>\n<li>Keystone이 인증된 사용자에 대해 발급하는 신분 증명용 토큰</li>\n<li>Scoped 토큰을 발급받기 위해 사용</li>\n<li>서비스(e.g. Nova)에 요청 할 수 없음</li>\n</ul>\n<p>Scoped 토큰:</p>\n<ul>\n<li>클라이언트(e.g. 유저, Nova, Glance)가 실행할 수 있는 범위가 담겨있는 토큰</li>\n<li>범위 내의 서비스(e.g. Nova)에 요청 할 수 있음</li>\n</ul>\n<p>아래는 이러한 사용자 로그인 과정을 시퀀스 다이어그램으로 표현하였습니다.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/77b08a28279cc5abfd2267eaebd29980/e088a/6d35a982-879c-41fa-9fde-b2ec15add6b6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 84.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAABvUlEQVQ4y41T2XLbMAz0//9MM+20D/mGTB96TFonamM7tURSIinetwpaiWI7bRKMH+QVdgEsoNV0iBDCfr/fbrdSynIIAL33bdtWUMjpMQCEHCGEtXa1QLvdtmkazsclDxSB2dze0oHC31kRQELI7v5eKf1AzjmHGEBiHEdKCMWYYdwjbK0LMZepLIqQGQ+RUlqdoV3brtfrzd2dszaEaLRwkvQdQm079H2K8aFSCPBwQoYxvK/14R0IQTm0+SLWH1BHOam9GKlqZilQ94QMI816x1H8GNnPkKYeY4RQTwh0pMGwkXvnXiFPyeLdtbFeMCpo/SnOJeOUDEaKF8gHkxziP973mHM6DJTCXBXTLMr9y23PZMzXH6WOSgqllHMWZu2aK/fr05vI5NuFqXABJ2nXETII+ieL328wLOowbmKeUgzW6HpZQhjrADklw56Df3IqJRdKUh27ubRxMiNnPQEm59wak+ZVGa0BYqMKskNfL7SrErBkWAceuMQ37Pqdz49THJ1TJcNJgJKBc9K96z7n2n9evo3iWB6+z40t4BP5aOYpxHI2MzBCTOfgv8j5uWFL3qvk8jzvf+Bs2F94UN2JQ6jJogAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"6d35a982 879c 41fa 9fde b2ec15add6b6\"\n        title=\"\"\n        src=\"/static/77b08a28279cc5abfd2267eaebd29980/d9199/6d35a982-879c-41fa-9fde-b2ec15add6b6.png\"\n        srcset=\"/static/77b08a28279cc5abfd2267eaebd29980/8ff5a/6d35a982-879c-41fa-9fde-b2ec15add6b6.png 240w,\n/static/77b08a28279cc5abfd2267eaebd29980/e85cb/6d35a982-879c-41fa-9fde-b2ec15add6b6.png 480w,\n/static/77b08a28279cc5abfd2267eaebd29980/d9199/6d35a982-879c-41fa-9fde-b2ec15add6b6.png 960w,\n/static/77b08a28279cc5abfd2267eaebd29980/e088a/6d35a982-879c-41fa-9fde-b2ec15add6b6.png 1015w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>[그림 1] 사용자 로그인 시퀀스 다이어그램</p>\n<h1>코드로 알아보자</h1>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/92985dd739a3ee975343903c785da0a1/bd48c/bc4f932b-5177-4cfe-9aaa-85ee5570807d.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 488px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 126.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsSAAALEgHS3X78AAACk0lEQVQ4y6VVS2/TQBDOH+YCXDhxQ+IECFQJIbWiUEoEgkqUUyUkEIJCW9EHlObhJm2SOvEjcV5+7a4/Zl3beJu0JWWkT+Od2RnP7ny7WxBC4DLw3gDcciBCBhFdMI9zFORHFEWYELJLYRu/MLx2F6Ob9+Atriq+yRChJpQ6haC/SQk+bsFfWwerteA+ew85MyJfGqfETEt4VqLtMvwb9+HdegReXJv052KVhKnD9z0YnTZM00DXtmOt149gHjegVSvo9bqwLRM/d7fhua6yMiWhSPalUjrA/OM5FJcW8WTuIV4tL6G4/Byr71aw8roYj5eezuPF4gL2dn6cnzCVwPdRr2molA9gGh2qtoO+46Ctn6DT1tFqNgkNWFS5tPNkr5WEQvCs7VcRpUJpcJweyuUyNE3DeDzOKHC2izESzuX3fSptGGNKhekfZ0FMbBk8Go2g6zrtkeyuCZ30OOmgmFblFGQVyoFshKSCpIttWZlmYUhL5DHJJSL+9zs/lnPCIDitUCb0GYfRpyptB4YzRIfObsvqwRq6GAQMfS9E3yfth+eAwaa5IW0bLTmC7YbYbPWx2XQUfDvqEmx8qVkxvh938TXRG40eoYt18kvsm2MEXHaZKux6DJ80Ax9KJzHk5L3OCLvtYYYdfUC2oWLL+35bbrxSSijgMgHDZbAosSn1NFzkS8B4wsNB34HeaqJ2qGE0HCS8EVMQ5XSUG5/asi5LDobU0ZAu0JSPsyKNK6SETA2zkjlP6ozY8uhp1Srq9Tpc14uJOmty5XKQwfkDPivk6my6O3O3jbjycnkS69FpUxJG/3hmz74hyjX2Pwl5kmzhcwPXX+7j9tsSHT//gmf0EhFJzJutNu6sVvFgrQ5nHOAPP4CMCwgRogYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"bc4f932b 5177 4cfe 9aaa 85ee5570807d\"\n        title=\"\"\n        src=\"/static/92985dd739a3ee975343903c785da0a1/bd48c/bc4f932b-5177-4cfe-9aaa-85ee5570807d.png\"\n        srcset=\"/static/92985dd739a3ee975343903c785da0a1/8ff5a/bc4f932b-5177-4cfe-9aaa-85ee5570807d.png 240w,\n/static/92985dd739a3ee975343903c785da0a1/e85cb/bc4f932b-5177-4cfe-9aaa-85ee5570807d.png 480w,\n/static/92985dd739a3ee975343903c785da0a1/bd48c/bc4f932b-5177-4cfe-9aaa-85ee5570807d.png 488w\"\n        sizes=\"(max-width: 488px) 100vw, 488px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>[그림 2] Horizon 콘솔 로그인</p>\n<p>Horizon 콘솔에서 User Name과 Password를 입력하고 [Sign In] 버튼을 누르면</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/afde310e4e8f8b0198c56de597fad374/7c1cd/3dd68033-693a-41d9-bb67-f028172813a8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 582px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 30.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAAAoklEQVQY05WP6wqDMAyF+/7PqGBbHCu9xzZN69RVEcZ++nE4JASSE+a955xrYyCCUgoAEIvW2jmvtckp19aIut1QrfXy1lZWiaSQwzAaY5xzCdGHGCKkjBmxF9b5rghLhL4fnA8hxm6wJIaIfOJcCGvd8RBWSpkm/lZKG1sKretnvznH+x/HpV/LiEgIOc+vMw5Af+XRZRzHUUqprd22/VHsL0QmW9d2D6RZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"3dd68033 693a 41d9 bb67 f028172813a8\"\n        title=\"\"\n        src=\"/static/afde310e4e8f8b0198c56de597fad374/7c1cd/3dd68033-693a-41d9-bb67-f028172813a8.png\"\n        srcset=\"/static/afde310e4e8f8b0198c56de597fad374/8ff5a/3dd68033-693a-41d9-bb67-f028172813a8.png 240w,\n/static/afde310e4e8f8b0198c56de597fad374/e85cb/3dd68033-693a-41d9-bb67-f028172813a8.png 480w,\n/static/afde310e4e8f8b0198c56de597fad374/7c1cd/3dd68033-693a-41d9-bb67-f028172813a8.png 582w\"\n        sizes=\"(max-width: 582px) 100vw, 582px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>[그림 3] POST 파라미터</p>\n<p>POST Method로 파라미터와 함께 <a href=\"http://localhost/auth/login\">http://localhost/auth/login</a> URL을 요청합니다.</p>\n<h2>Horizon (Back-end)</h2>\n<h4>horizon/openstack_auth/urls.py</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">urlpatterns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  url<span class=\"token punctuation\">(</span><span class=\"token string\">r\"^login/$\"</span><span class=\"token punctuation\">,</span> views<span class=\"token punctuation\">.</span>login<span class=\"token punctuation\">,</span> name<span class=\"token operator\">=</span><span class=\"token string\">'login'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token punctuation\">]</span></code></pre></div>\n<h4>horizon/openstack_dashboard/settings.py</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">AUTHENTICATION_BACKENDS <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'openstack_auth.backend.KeystoneBackend'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">AUTHENTICATION_BACKENDS</code> 옵션을 통해 Django 인증 로직을 커스터마이징할 수 있습니다.</p>\n<h4>horizon/openstack_auth/views.py</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth <span class=\"token keyword\">import</span> views <span class=\"token keyword\">as</span> django_auth_views\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token decorator annotation punctuation\">@sensitive_post_parameters</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token decorator annotation punctuation\">@csrf_protect</span>\n<span class=\"token decorator annotation punctuation\">@never_cache</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n    res <span class=\"token operator\">=</span> django_auth_views<span class=\"token punctuation\">.</span>LoginView<span class=\"token punctuation\">.</span>as_view<span class=\"token punctuation\">(</span>\n      template_name<span class=\"token operator\">=</span>template_name<span class=\"token punctuation\">,</span>\n      redirect_field_name<span class=\"token operator\">=</span>auth<span class=\"token punctuation\">.</span>REDIRECT_FIELD_NAME<span class=\"token punctuation\">,</span>\n      form_class<span class=\"token operator\">=</span>form<span class=\"token punctuation\">,</span>\n      extra_context<span class=\"token operator\">=</span>extra_context<span class=\"token punctuation\">,</span>\n      redirect_authenticated_user<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">except</span> exceptions<span class=\"token punctuation\">.</span>KeystonePassExpiredException <span class=\"token keyword\">as</span> exc<span class=\"token punctuation\">:</span>\n    res <span class=\"token operator\">=</span> django_http<span class=\"token punctuation\">.</span>HttpResponseRedirect<span class=\"token punctuation\">(</span>\n      reverse<span class=\"token punctuation\">(</span><span class=\"token string\">'password'</span><span class=\"token punctuation\">,</span> args<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>exc<span class=\"token punctuation\">.</span>user_id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    msg <span class=\"token operator\">=</span> _<span class=\"token punctuation\">(</span><span class=\"token string\">\"Your password has expired. Please set a new password.\"</span><span class=\"token punctuation\">)</span>\n    res<span class=\"token punctuation\">.</span>set_cookie<span class=\"token punctuation\">(</span><span class=\"token string\">'logout_reason'</span><span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">,</span> max_age<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">django_auth_views.LoginView.as_view()</code> 를 호출하면 사용자 인증 화면이 표시됩니다. 그 후, 사용자가 작성한 Form을 Submit 하게되면 Django 인증 시스템이 실행됩니다. (<code class=\"language-text\">AUTHENTICATION_BACKENDS</code> 옵션에 따라 Custom 인증인 <code class=\"language-text\">openstack_auth.backend.KeystoneBackend</code> 모듈을 호출)\n<code class=\"language-text\">openstack_auth.backend.KeystoneBackend</code> 모듈의 핵심은 Unscoped 토큰을 Keystone에게서 발급 받는 것으로, 모듈이 호출되면 Unscoped 토큰 발급 요청을 진행합니다.</p>\n<h4>horizon/openstack_auth/backend.py</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># TODO(stephenfin): Subclass 'django.contrib.auth.backends.BaseBackend' once we</span>\n<span class=\"token comment\"># (only) support Django 3.0</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">KeystoneBackend</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token triple-quoted-string string\">\"\"\"Django authentication backend for use with ``django.contrib.auth``.\"\"\"</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token function\">authenticate</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> auth_url<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Authenticates a user via the Keystone Identity API.\"\"\"</span>\n    LOG<span class=\"token punctuation\">.</span>debug<span class=\"token punctuation\">(</span><span class=\"token string\">'Beginning user authentication'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> auth_url<span class=\"token punctuation\">:</span>\n      auth_url <span class=\"token operator\">=</span> settings<span class=\"token punctuation\">.</span>OPENSTACK_KEYSTONE_URL\n\n    auth_url<span class=\"token punctuation\">,</span> url_fixed <span class=\"token operator\">=</span> utils<span class=\"token punctuation\">.</span>fix_auth_url_version_prefix<span class=\"token punctuation\">(</span>auth_url<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> url_fixed<span class=\"token punctuation\">:</span>\n      LOG<span class=\"token punctuation\">.</span>warning<span class=\"token punctuation\">(</span><span class=\"token string\">\"The OPENSTACK_KEYSTONE_URL setting points to a v2.0 \"</span>\n                  <span class=\"token string\">\"Keystone endpoint, but v3 is specified as the API \"</span>\n                  <span class=\"token string\">\"version to use by Horizon. Using v3 endpoint for \"</span>\n                  <span class=\"token string\">\"authentication.\"</span><span class=\"token punctuation\">)</span>\n\n    plugin<span class=\"token punctuation\">,</span> unscoped_auth <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_get_auth_backend<span class=\"token punctuation\">(</span>auth_url<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>Custom 인증 모듈의 클래스에는 authenticate 메서드가 있어야 합니다. Django 인증 시스템이 Custom 인증을 실행할 때 authenticate 메서드를 호출합니다.</p>\n<p>토큰 발급과 관련된 모듈은 2개로 아래와 같습니다.</p>\n<p>keystoneauth1:</p>\n<ul>\n<li>OpenStack 기반 클라우드 인증을 위한 도구</li>\n<li>오픈스택 인증 플러그인 포함 (password, token, and federation based)</li>\n<li>클라이언트의 설정을 세션으로 유지하면서 요청할 수 있도록 함. (based on the requests Python library)</li>\n</ul>\n<p>keystoneclient:</p>\n<ul>\n<li>Keystone API의 클라이언트 (CLI로 Keystone을 이용할 수 있음)</li>\n</ul>\n<h4>horizon/openstack_auth/backend.py</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> openstackit<span class=\"token punctuation\">.</span>openstack_auth <span class=\"token keyword\">import</span> user <span class=\"token keyword\">as</span> auth_user\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token comment\"># TODO(stephenfin): Subclass 'django.contrib.auth.backends.BaseBackend' once we</span>\n<span class=\"token comment\"># (only) support Django 3.0</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">KeystoneBackend</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token triple-quoted-string string\">\"\"\"Django authentication backend for use with ``django.contrib.auth``.\"\"\"</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token function\">authenticate</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> auth_url<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token comment\"># If we made it here we succeeded. Create our User!</span>\n    unscoped_token <span class=\"token operator\">=</span> unscoped_auth_ref<span class=\"token punctuation\">.</span>auth_token\n\n    user <span class=\"token operator\">=</span> auth_user<span class=\"token punctuation\">.</span>create_user_from_token<span class=\"token punctuation\">(</span>\n        request<span class=\"token punctuation\">,</span>\n        auth_user<span class=\"token punctuation\">.</span>Token<span class=\"token punctuation\">(</span>scoped_auth_ref<span class=\"token punctuation\">,</span> unscoped_token<span class=\"token operator\">=</span>unscoped_token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        endpoint<span class=\"token punctuation\">,</span>\n        services_region<span class=\"token operator\">=</span>region_name<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> request <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># if no k2k providers exist then the function returns quickly</span>\n      utils<span class=\"token punctuation\">.</span>store_initial_k2k_session<span class=\"token punctuation\">(</span>auth_url<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> scoped_auth_ref<span class=\"token punctuation\">,</span>\n                                      unscoped_auth_ref<span class=\"token punctuation\">)</span>\n      request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'unscoped_token'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> unscoped_token\n      <span class=\"token keyword\">if</span> domain_auth_ref<span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># check django session engine, if using cookies, this will not</span>\n        <span class=\"token comment\"># work, as it will overflow the cookie so don't add domain</span>\n        <span class=\"token comment\"># scoped token to the session and put error in the log</span>\n        <span class=\"token keyword\">if</span> utils<span class=\"token punctuation\">.</span>using_cookie_backed_sessions<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n          LOG<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">(</span><span class=\"token string\">'Using signed cookies as SESSION_ENGINE with '</span>\n                    <span class=\"token string\">'OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT is '</span>\n                    <span class=\"token string\">'enabled. This disables the ability to '</span>\n                    <span class=\"token string\">'perform identity operations due to cookie size '</span>\n                    <span class=\"token string\">'constraints.'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n          request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'domain_token'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> domain_auth_ref\n\n      request<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> user\n\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<h4>horizon/openstack_auth/plugin/base.py</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">get_access_info</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> keystone_auth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token triple-quoted-string string\">\"\"\"Get the access info from an unscoped auth\n\n  This function provides the base functionality that the\n  plugins will use to authenticate and get the access info object.\n\n  :param keystone_auth: keystoneauth1 identity plugin\n  :raises: exceptions.KeystoneAuthException on auth failure\n  :returns: keystoneclient.access.AccessInfo\n  \"\"\"</span>\n  session <span class=\"token operator\">=</span> utils<span class=\"token punctuation\">.</span>get_session<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n    unscoped_auth_ref <span class=\"token operator\">=</span> keystone_auth<span class=\"token punctuation\">.</span>get_access<span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">except</span> keystone_exceptions<span class=\"token punctuation\">.</span>ConnectFailure <span class=\"token keyword\">as</span> exc<span class=\"token punctuation\">:</span>\n    LOG<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>exc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    msg <span class=\"token operator\">=</span> _<span class=\"token punctuation\">(</span><span class=\"token string\">'Unable to establish connection to keystone endpoint.'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">raise</span> exceptions<span class=\"token punctuation\">.</span>KeystoneConnectionException<span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">except</span> <span class=\"token punctuation\">(</span>keystone_exceptions<span class=\"token punctuation\">.</span>Unauthorized<span class=\"token punctuation\">,</span>\n          keystone_exceptions<span class=\"token punctuation\">.</span>Forbidden<span class=\"token punctuation\">,</span>\n          keystone_exceptions<span class=\"token punctuation\">.</span>NotFound<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> exc<span class=\"token punctuation\">:</span>\n    msg <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>exc<span class=\"token punctuation\">)</span>\n    LOG<span class=\"token punctuation\">.</span>debug<span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span>\n    match <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">(</span><span class=\"token string\">r\"The password is expired and needs to be changed\"</span>\n                      <span class=\"token string\">r\" for user: ([^.]*)[.].*\"</span><span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> match<span class=\"token punctuation\">:</span>\n        exc <span class=\"token operator\">=</span> exceptions<span class=\"token punctuation\">.</span>KeystonePassExpiredException<span class=\"token punctuation\">(</span>\n            _<span class=\"token punctuation\">(</span><span class=\"token string\">'Password expired.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        exc<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> match<span class=\"token punctuation\">.</span>group<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">raise</span> exc\n    msg <span class=\"token operator\">=</span> _<span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid credentials.'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">raise</span> exceptions<span class=\"token punctuation\">.</span>KeystoneCredentialsException<span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">except</span> <span class=\"token punctuation\">(</span>keystone_exceptions<span class=\"token punctuation\">.</span>ClientException<span class=\"token punctuation\">,</span>\n          keystone_exceptions<span class=\"token punctuation\">.</span>AuthorizationFailure<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> exc<span class=\"token punctuation\">:</span>\n    msg <span class=\"token operator\">=</span> _<span class=\"token punctuation\">(</span><span class=\"token string\">\"An error occurred authenticating. \"</span>\n            <span class=\"token string\">\"Please try again later.\"</span><span class=\"token punctuation\">)</span>\n    LOG<span class=\"token punctuation\">.</span>debug<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>exc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">raise</span> exceptions<span class=\"token punctuation\">.</span>KeystoneAuthException<span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> unscoped_auth_ref</code></pre></div>\n<p>User 인스턴스를 생성하는지에 따라 Django 인증 시스템이 인증 완료 여부를 판단합니다. 즉, 인증 로직이 성공적으로 끝났다면 User 인스턴스를 생성해 Django에게 사용자가 인증되었음을 알려주어야 합니다.\nHorizon은 Unscoped 토큰 발급이 성공적으로 이루어지면 <code class=\"language-text\">auth_user.create_user_from_token()</code> 함수를 호출해 User 인스턴스를 생성합니다. 그리고 만들어진 User 인스턴스를 request.user에 저장합니다. (Unscoped 토큰은 request.session[‘unscoped_token’] = unscoped_token 코드에 의해 Session에 저장)</p>\n<h4>horizon/openstack_auth/user.py</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">create_user_from_token</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> endpoint<span class=\"token punctuation\">,</span> services_region<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># if the region is provided, use that, otherwise use the preferred region</span>\n  svc_region <span class=\"token operator\">=</span> services_region <span class=\"token keyword\">or</span> \\\n    utils<span class=\"token punctuation\">.</span>default_services_region<span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span>serviceCatalog<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> endpoint<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> User<span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token operator\">=</span>token<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n              token<span class=\"token operator\">=</span>token<span class=\"token punctuation\">,</span>\n              user<span class=\"token operator\">=</span>token<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">[</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n              password_expires_at<span class=\"token operator\">=</span>token<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">[</span><span class=\"token string\">'password_expires_at'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n              user_domain_id<span class=\"token operator\">=</span>token<span class=\"token punctuation\">.</span>user_domain_id<span class=\"token punctuation\">,</span>\n              <span class=\"token comment\"># We need to consider already logged-in users with an old</span>\n              <span class=\"token comment\"># version of Token without user_domain_name.</span>\n              user_domain_name<span class=\"token operator\">=</span><span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> <span class=\"token string\">'user_domain_name'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n              project_id<span class=\"token operator\">=</span>token<span class=\"token punctuation\">.</span>project<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n              project_name<span class=\"token operator\">=</span>token<span class=\"token punctuation\">.</span>project<span class=\"token punctuation\">[</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n              domain_id<span class=\"token operator\">=</span>token<span class=\"token punctuation\">.</span>domain<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n              domain_name<span class=\"token operator\">=</span>token<span class=\"token punctuation\">.</span>domain<span class=\"token punctuation\">[</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n              enabled<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n              service_catalog<span class=\"token operator\">=</span>token<span class=\"token punctuation\">.</span>serviceCatalog<span class=\"token punctuation\">,</span>\n              roles<span class=\"token operator\">=</span>token<span class=\"token punctuation\">.</span>roles<span class=\"token punctuation\">,</span>\n              endpoint<span class=\"token operator\">=</span>endpoint<span class=\"token punctuation\">,</span>\n              services_region<span class=\"token operator\">=</span>svc_region<span class=\"token punctuation\">,</span>\n              is_federated<span class=\"token operator\">=</span><span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> <span class=\"token string\">'is_federated'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n              unscoped_token<span class=\"token operator\">=</span><span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> <span class=\"token string\">'unscoped_token'</span><span class=\"token punctuation\">,</span>\n                                    request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'unscoped_token'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">create_user_from_token()</code> 함수는 User 인스턴스를 생성해 Return 합니다.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9c4fee0ebaed676ac043df529be2d821/23296/9794cda6-4b39-4754-9803-3476eae444f0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 675px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 17.083333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAlUlEQVQI11XIwQqCQBDGcR+gTp3KDFFzdndmdlcjCD10KC3vBR00pfd/iAYPQfBj+H8TrC991I7xfUy6T9QMu9t72w6bax/OHTa9zLibkm5anV+L6rGsnz8BkT8VlePy4I+IVhk0xKBMuocsFyqT+JfOJAI0WFLhiS2TZy6c89YSIiOSkWsss3wcW9Ra5aBzpUGAAvgCTmAiF+bBZAIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"9794cda6 4b39 4754 9803 3476eae444f0\"\n        title=\"\"\n        src=\"/static/9c4fee0ebaed676ac043df529be2d821/23296/9794cda6-4b39-4754-9803-3476eae444f0.png\"\n        srcset=\"/static/9c4fee0ebaed676ac043df529be2d821/8ff5a/9794cda6-4b39-4754-9803-3476eae444f0.png 240w,\n/static/9c4fee0ebaed676ac043df529be2d821/e85cb/9794cda6-4b39-4754-9803-3476eae444f0.png 480w,\n/static/9c4fee0ebaed676ac043df529be2d821/23296/9794cda6-4b39-4754-9803-3476eae444f0.png 675w\"\n        sizes=\"(max-width: 675px) 100vw, 675px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>[그림 4] token 파라미터 값 (openstackit.openstack_auth.user.Token 자료형)</p>\n<h4>horizon/openstack_auth/views.py</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> openstack_auth <span class=\"token keyword\">import</span> user <span class=\"token keyword\">as</span> auth_user\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token decorator annotation punctuation\">@sensitive_post_parameters</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token decorator annotation punctuation\">@csrf_protect</span>\n<span class=\"token decorator annotation punctuation\">@never_cache</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> template_name<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> extra_context<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token comment\"># Set the session data here because django's session key rotation</span>\n  <span class=\"token comment\"># will erase it if we set it earlier.</span>\n  <span class=\"token keyword\">if</span> request<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>is_authenticated<span class=\"token punctuation\">:</span>\n    auth_user<span class=\"token punctuation\">.</span>set_session_from_user<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">)</span>\n    regions <span class=\"token operator\">=</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">(</span>forms<span class=\"token punctuation\">.</span>get_region_choices<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    region <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>endpoint\n    login_region <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>POST<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'region'</span><span class=\"token punctuation\">)</span>\n    region_name <span class=\"token operator\">=</span> regions<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>login_region<span class=\"token punctuation\">)</span>\n    request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'region_endpoint'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> region\n    request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'region_name'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> region_name\n    expiration_time <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>time_until_expiration<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    threshold_days <span class=\"token operator\">=</span> settings<span class=\"token punctuation\">.</span>PASSWORD_EXPIRES_WARNING_THRESHOLD_DAYS\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>expiration_time <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span> <span class=\"token keyword\">and</span>\n          expiration_time<span class=\"token punctuation\">.</span>days <span class=\"token operator\">&lt;=</span> threshold_days <span class=\"token keyword\">and</span>\n          expiration_time <span class=\"token operator\">></span> datetime<span class=\"token punctuation\">.</span>timedelta<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n      expiration_time <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>expiration_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>rsplit<span class=\"token punctuation\">(</span><span class=\"token string\">':'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n      msg <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">(</span><span class=\"token string\">'Please consider changing your password, it will expire'</span>\n               <span class=\"token string\">' in %s minutes'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span>\n            expiration_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">':'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">' Hours and '</span><span class=\"token punctuation\">)</span>\n      messages<span class=\"token punctuation\">.</span>warning<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Custom 인증이 완료되면 다시, horizon/openstack<em>auth/views.py 로 돌아옵니다. 그리고 여기에서 token, user</em>id, region<em>endpoint, services</em>region을 추가적으로 Session에 저장합니다.</p>\n<h4>horizon/openstack_auth/user.py</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">set_session_from_user</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>token\n  request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'user_id'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\n  request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'region_endpoint'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>endpoint\n  request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'services_region'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>services_region\n  <span class=\"token comment\"># Update the user object cached in the request</span>\n  request<span class=\"token punctuation\">.</span>_cached_user <span class=\"token operator\">=</span> user\n  request<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> user</code></pre></div>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/48b78989ec338d84c912954b63dbec23/91b29/f3ebb32e-9816-4bc0-972a-2afa63bc7e1e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 6.666666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAAsSAAALEgHS3X78AAAARElEQVQI12O4effBsbOXzl+8cu3Gnas3bl+/ff/M1Tunzpw/d+kqUOTaTaDgnRu37kHY12/evnjj3on9+6/u2njl4F4A9i0xl74sZI4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"f3ebb32e 9816 4bc0 972a 2afa63bc7e1e\"\n        title=\"\"\n        src=\"/static/48b78989ec338d84c912954b63dbec23/d9199/f3ebb32e-9816-4bc0-972a-2afa63bc7e1e.png\"\n        srcset=\"/static/48b78989ec338d84c912954b63dbec23/8ff5a/f3ebb32e-9816-4bc0-972a-2afa63bc7e1e.png 240w,\n/static/48b78989ec338d84c912954b63dbec23/e85cb/f3ebb32e-9816-4bc0-972a-2afa63bc7e1e.png 480w,\n/static/48b78989ec338d84c912954b63dbec23/d9199/f3ebb32e-9816-4bc0-972a-2afa63bc7e1e.png 960w,\n/static/48b78989ec338d84c912954b63dbec23/91b29/f3ebb32e-9816-4bc0-972a-2afa63bc7e1e.png 983w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>[그림 5] session_data 컬럼에 base64로 인코딩 되어 저장</p>\n<h1>로그인 후, 서비스 요청 (시퀀스 다이어그램)</h1>\n<p>Unscoped 토큰은 신분만 증명할 뿐, 서비스(e.g. Nova)에 서비스를 요청할 수 없습니다. 다시말해, 서비스를 요청하기 위해서는 endpoint와 범위가 지정되어 있는 Scoped 토큰이 필요합니다. Horizon은 Scoped 토큰을 얻기 위해 Session에 저장되어 있는 Unscoped 토큰으로 Keystone에게 Scoped 토큰을 요청합니다. Unscoped 토큰이 검증되어 Scoped 토큰이 성공적으로 발급되면 서비스를 요청할 수 있는 권한이 부여됩니다. 다시, Horizon은 서비스 요청 내용과 Scoped 토큰을 함께 서비스에게 보냅니다.</p>\n<blockquote>\n<p>An unscoped token contains neither a service catalog, any roles, a project scope, nor a domain scope. Their primary use case is simply to prove your identity to keystone at a later time (usually to generate scoped tokens), without repeatedly presenting your original credentials.</p>\n</blockquote>\n<p>이후, 서비스는 Horizon이 보내온 Scoped 토큰을 검증하기 위해 Keystone에게 검증 의뢰를 합니다. 토큰 검증에 문제가 없다면 사용자의 서비스 요청을 실행합니다. 요청이 완료되면 그 결과를 사용자에게 보고합니다.</p>\n<p>아래는 로그인 후, 서비스 요청 과정에 대한 다이어그램입니다.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b70b610f5d384b72356f55e999e62435/061c7/54d4471e-0806-4090-a7c4-2b6cd6be2629.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABiElEQVQoz41SXW/bMAzM//9TfVo7bMNa9GF7GZZ0ievYkSXL+pYopSerMLaiBcYHWxTvyCOpnRDi8PSktL6uJuW8PxyklM1VSvV9v7neeyG4tTbnDHdnjBnHkV0uwKWUnLVwEW5oItJahxCaCwBCMcZSSiXjR5RmxsbzGSq0Mbb/TtHpRaEgoIg2aLON+UpGvi2Gez3+cGaZL4xzrtSS6G9uJW/nf8krSndfx/7I2LQsMqbk1VBK/g9yM/Ho9TycBxjKq+eHGKzRBi28Ab9T2RzvpEBhjsH6QOb0WUkevY/r2BLljypXcjx/6/7sp4ljEblcw9ITvUrNuQT2s8Hel53ZPUXsI6E9ytmKU/AOiSbGhmFU+5uK2Vb1pnKZHq65KnTOLsrMh09Df0IP3juHV9LdlkwfD4w/NjLy+BAt+5UJU6/bhhzbffHOCl6b2tXdaN1iIYZFadfdRa+hC89rvYR2yCz4YuT6eDsLjuGDUsnIgROgqRpZ9jt4CwatBrWItDMqB3na1v4CvxzzLhOXdf0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"54d4471e 0806 4090 a7c4 2b6cd6be2629\"\n        title=\"\"\n        src=\"/static/b70b610f5d384b72356f55e999e62435/d9199/54d4471e-0806-4090-a7c4-2b6cd6be2629.png\"\n        srcset=\"/static/b70b610f5d384b72356f55e999e62435/8ff5a/54d4471e-0806-4090-a7c4-2b6cd6be2629.png 240w,\n/static/b70b610f5d384b72356f55e999e62435/e85cb/54d4471e-0806-4090-a7c4-2b6cd6be2629.png 480w,\n/static/b70b610f5d384b72356f55e999e62435/d9199/54d4471e-0806-4090-a7c4-2b6cd6be2629.png 960w,\n/static/b70b610f5d384b72356f55e999e62435/061c7/54d4471e-0806-4090-a7c4-2b6cd6be2629.png 1216w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>[그림 6] 로그인 후, 서비스 요청 시퀀스 다이어그램</p>\n<h1>Django Session</h1>\n<p>Session 기반 인증에서 Session 저장소의 위치는 중요한 이슈사항이 됩니다. 로드밸런서에 의해 트래픽이 분산되는 환경일 때, 서버 각각 Session 저장소를 분리되어 있으면 Session의 정보를 공유하고 있지 않아 사용자를 식별할 수 없는 문제가 발생됩니다.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e8cce062bcc7d3c28cd77ac9e16567ce/adc48/c0ec7e99-05cb-431f-b43e-875f7435fa5e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABIklEQVQoz31SCY6DMAzM/59ZaEGlBULITZi1TbPqVmUjWeaQx3NE4Z+z77v0nDOmaZJez7ZtcM4hxiid3/moOvhZ74ApJSzLIsP0EYXKOY/H44GmadD3PcZxRAgBqg6dsXsH5AG9GPiY4UPCuq6Y5xld10k9n8+DYSlFaHvvYa0l+oe0RIwYeCOpWi8w1mO1ATM9fy5nDC7FQPf7XdBvt5swsdYh5R2TNnDExPkk8lYXiG0mL9Op72oYBlwuFwFl440xJC0SYME0a5IWybuEkf4xOx+yMGRWHBKz4l4tUjWl+JJXyv4nyZoyM+cgjiUZZvVCgJVxIGwVz6uzQL6FwkurV6yCgdq2laSv1+sRyrcr83l9soSiBfht7e//EI4wOdQfNXe/6OXz1mgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"c0ec7e99 05cb 431f b43e 875f7435fa5e\"\n        title=\"\"\n        src=\"/static/e8cce062bcc7d3c28cd77ac9e16567ce/d9199/c0ec7e99-05cb-431f-b43e-875f7435fa5e.png\"\n        srcset=\"/static/e8cce062bcc7d3c28cd77ac9e16567ce/8ff5a/c0ec7e99-05cb-431f-b43e-875f7435fa5e.png 240w,\n/static/e8cce062bcc7d3c28cd77ac9e16567ce/e85cb/c0ec7e99-05cb-431f-b43e-875f7435fa5e.png 480w,\n/static/e8cce062bcc7d3c28cd77ac9e16567ce/d9199/c0ec7e99-05cb-431f-b43e-875f7435fa5e.png 960w,\n/static/e8cce062bcc7d3c28cd77ac9e16567ce/adc48/c0ec7e99-05cb-431f-b43e-875f7435fa5e.png 979w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>[그림 7] 노드 각각 Session 저장소를 분리할 경우, 트래픽 분산 시 사용자를 식별할 수 없음</p>\n<p>때문에, Django Session은 기본 설정으로 한 곳의 데이터베이스에 Session 정보를 저장하도록 되어 있습니다.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e2cb81e56e60d1ccdace3ca50116e45f/5a3c9/e8c394b6-1da9-41dc-9dea-6ee53ba401a0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 39.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAA9ElEQVQoz22SWY6EMAxEuf8t+UIsgs6+UxObCR2YKckStuzKc8KAqvM8H9FqJGMMrLVoSindteD9o5c09ElTb26M5WEyKqXm1mFZFszzDKU0aJz6cs4cQzMopXDhfQCZUQipobRDTPmuxRjrHLhmjIavxEzonMO+75BSciOTGKLK0FpXMwUf0mP1XgRC18CE67piHEdM04Rt29jI+YSP0LAuQta1PuIyNNWwX4+2ugwLhBAXIdERGTX09xdC4IHvygrGhWrqcRwHB1GRZ9uEvIb3Y7zVDAsTnZUigLaihyHD38H7HYb/fpc+J3qlVH/sn+8e5Aebg3POdPE8hgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"e8c394b6 1da9 41dc 9dea 6ee53ba401a0\"\n        title=\"\"\n        src=\"/static/e2cb81e56e60d1ccdace3ca50116e45f/d9199/e8c394b6-1da9-41dc-9dea-6ee53ba401a0.png\"\n        srcset=\"/static/e2cb81e56e60d1ccdace3ca50116e45f/8ff5a/e8c394b6-1da9-41dc-9dea-6ee53ba401a0.png 240w,\n/static/e2cb81e56e60d1ccdace3ca50116e45f/e85cb/e8c394b6-1da9-41dc-9dea-6ee53ba401a0.png 480w,\n/static/e2cb81e56e60d1ccdace3ca50116e45f/d9199/e8c394b6-1da9-41dc-9dea-6ee53ba401a0.png 960w,\n/static/e2cb81e56e60d1ccdace3ca50116e45f/5a3c9/e8c394b6-1da9-41dc-9dea-6ee53ba401a0.png 1169w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>[그림 8] Django Session은 한 곳의 데이터베이스에 Session 정보를 저장 (Session의 정보를 공유하고 있기에 사용자 식별이 유지됨)</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e1a98b5cf01332ed90bdc35ab8c20668/4a279/c0d82486-9b2b-48e4-bc74-50477d865b29.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 239px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 76.56903765690377%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAACUElEQVQoz41ROW/UQBjd3xX4B9SUUFAgIRSUgg5ooIACEEUCRBxJCiJEDgJROEQBgYIGJaBkD9vj8Xh8jI+Zsdf2ete7eM23u1JWIER4+iyNZb/35nuvlrXjuukuHoQuY2HIPc8LgiDNsuo/UMuzVGf8Ne0SJzCo61iWjo24HcO34XB4DBmeoigYQZW6lfqGYVKDmOA/GAzG9OE/JEbk/mAAV63cr52Q6JqKCaHUGpOr452rsbZru8+U+J2Z5BEH/ziOXcd2bNukFlwNfiiHf6I20QB2GkvcLvQwtsHXApqFkMZcV1G1XtH/awRTskvwSkNsKUHkOc2WAotQaloUlGzBBcaQo6GpLUxMwzB0HUEtU3InTY12QUTKAx868z1m25aU0qSUeR5jLEmSwPccB94AjHM5JVtYW2nwly0/sMnhYR3cdIRgEDYIwcTAiqb3f0+xdnTqdjpePmDtjghDGcVSCnCD2CIoPZJCiCDkP8uyOirwKDAARcqTOl+vO6jZQFjf29sPAT5TNKSqarPZcD0fI+37/r7lehOJWgViZTksyyLPcNSlMg2YA1a2RaXgkeCwdhJH4D1yD31oIWkno3bLctozMcmymmxoooVwi7rfGojJ2OHyR0s9xPYBMlVq1zFN8v4ko9HOvd01mO7uWv7xOf7y3vy0zTYfhNuPyeo979WieLPENhaczYdi56l8u8x3lpIPq8Xn9QmrFl2agRGzM+Xts/evX3lx82q1cCG9e7736HJ243R260w+fzG/cy6fn02vnUrmTsRzJycUmF/frSoDUpdnigAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"c0d82486 9b2b 48e4 bc74 50477d865b29\"\n        title=\"\"\n        src=\"/static/e1a98b5cf01332ed90bdc35ab8c20668/4a279/c0d82486-9b2b-48e4-bc74-50477d865b29.png\"\n        srcset=\"/static/e1a98b5cf01332ed90bdc35ab8c20668/4a279/c0d82486-9b2b-48e4-bc74-50477d865b29.png 239w\"\n        sizes=\"(max-width: 239px) 100vw, 239px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>[그림 9] horizon 데이터베이스에 django_session 테이블에 저장</p>\n<h2>Session Cookie</h2>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a8ae29d1078fd864637504f7dae67976/ee455/ee013e72-cf46-4df8-a2e8-89b2cc0b9c49.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 863px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 20.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAkklEQVQI123MyQ6DMBADUP7/D3tphVJIyErINiEIaqjoqdLTyAd7up69jXUhxJhyzuWrFBpGwSepjVXaQEqZqP4Uqqh1g9CMKx8pUqvbQe2EIPTMhMLlyoG0i3JB4Z5hMT6h1mH5YlxaH3K9xjsgTMb5VPK6pdpO1OIl3VDDWD6evZ5Dxea2bscozRywPf7Cd9Q+Ulzk0Dx6yvsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"ee013e72 cf46 4df8 a2e8 89b2cc0b9c49\"\n        title=\"\"\n        src=\"/static/a8ae29d1078fd864637504f7dae67976/ee455/ee013e72-cf46-4df8-a2e8-89b2cc0b9c49.png\"\n        srcset=\"/static/a8ae29d1078fd864637504f7dae67976/8ff5a/ee013e72-cf46-4df8-a2e8-89b2cc0b9c49.png 240w,\n/static/a8ae29d1078fd864637504f7dae67976/e85cb/ee013e72-cf46-4df8-a2e8-89b2cc0b9c49.png 480w,\n/static/a8ae29d1078fd864637504f7dae67976/ee455/ee013e72-cf46-4df8-a2e8-89b2cc0b9c49.png 863w\"\n        sizes=\"(max-width: 863px) 100vw, 863px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>[그림 10] 쿠키에 저장되는 sessionid</p>\n<p>클라이언트는 sessionid를 쿠키로 저장합니다. 그리고 서버 요청 시 쿠키에 저장된 sessionid와 함께 보내, 서버가 사용자를 식별할 수 있도록 합니다. 만약, sessionid Name을 가진 쿠키를 지우게 되면 서버는 사용자를 식별할 수 없어 로그인이 풀리게 됩니다.</p>\n<p>다만, 로그아웃과 달리 세션 정보를 지운 것이 아니기 때문에 예전 sessionid 값을 다시 쿠키에 담아 요청하면 다시 로그인을 유지할 수 있습니다. 아래는 이에 대한 시나리오입니다.</p>\n<h4>- 쿠키를 제거하고 새로고침</h4>\n<p>사용자를 식별할 수 없어 로그인이 풀림.</p>\n<h4>- 쿠키를 이전 값으로 설정하고 새로고침</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  Name: sessionid\n  Value: yoho40qgmc9ivjy25yua78tu5pp7vpt8\n  Expires / Max-Age: 2021-02-17T08:00:20.116Z\n}</code></pre></div>\n<p>인증이 유지됨.</p>\n<h4>참고 사항</h4>\n<blockquote>\n<p>sessionid 값을 다시 쿠키에 담고 새로고침할 때 URL이 중요합니다.</p>\n<p><a href=\"http://localhost/auth/login/\">http://localhost/auth/login/</a>\n의 URL에서는 성공적으로 인증이 이루어지지만,</p>\n<p><a href=\"http://localhost/auth/login/?next=/project/\">http://localhost/auth/login/?next=/project/</a>\nnext 쿼리 스트링이 존재하면\n\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 458px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 160.41666666666669%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAgCAIAAACdAM/hAAAACXBIWXMAAAsSAAALEgHS3X78AAADFElEQVQ4y5VVS3PTMBDOv2SGH8Clf4IDh557Ag4c6ZRCYULp+0GB0saOnbQl09K8aBI5sRNbku0olmU7rJykr2k7yc6XndVq199q9UgmjuPkEYkDHrPgiYAMzA3vSeoRasl78cqbmx+8+3LtvCf3k+UHowgMvvGbbxzG2O0vLEr/hP6p5OEkOdxX/bn5/ss3fJScOp9ijqJICBHyMB4mgnhBvhQcndrn5TCOIAw7NmP9B5JH9ajHRysfFrMrH1eWFr9mP3/bXlvf31pdyx7sbn9aer+zuZZdWb4OHifLxqafuDgvra9mN1azB3s7ytFh6aT4Y29HU3I/v+/tbK6fFPTc0SFj7Dr//prjGGp/YHm3CW/KhlCMsWVZBJNxt9NC7mx4Kg90G5INA1XK5V6vN9mrZDid3Ck7mREZWCOzLA8h32j3JYwJ2v32tSc1Oh1mmiOAzSmF5JiWyx1FMVXV0rSxVhTQXb1g5eXQ0qWnd3pKK5URyOUl63Rk2TAwDn91VJWUK26tRmtV0CmqYJNandbrtFZ36zeg1erAsmTZkjl3DAySP5+3tHy3WJSGqpjFk6s/l7XTy9rZX3dCe4dZuG7o4BCTFDiw7UHPDmwnGGnbGaQIbgECQs9Pt6pttBBqtlDHtMAIOJ9hq/q+59g2gDhOr2th7EShgGsUPw55gThPG8YC0yEWcbvUMzFt24QOuB9GI3hcSIMLafBIIoxoEFI2yMBlu7CZhkih7eqGqxlUN6jaxErDOW44uYattnCu4ShNBwwdETklbWL4ApKTs467WWpslVq7FwbMQUQBER3RfJNoaYLWksMCokXD1VtyqCGKvFAym0FisKTNkgblyBPID1s+aGGkGoKk9sOJIf1NL7QZMAvRNc22AS1Hk3M+5dFObxWhFKcSChHNInduVTyLyGT42b0uCDAPZxRoGCT3TNMkhEzJCa9FEMA55OMHcPqy4YBBOLTJdd1MPKPAizZq9bjbySwiohj3ueNzFoiH/ugekThdnX5Fn789efa6uLD9TzJPvTeyYAOzZQUt5dBxxfkP9CcZJFpEazcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"6c5ed9f3 f64a 4dfc 9454 9260a072f835\"\n        title=\"\"\n        src=\"/static/5497342ce676e8a64b2f559cc0bc56ed/f7a31/6c5ed9f3-f64a-4dfc-9454-9260a072f835.png\"\n        srcset=\"/static/5497342ce676e8a64b2f559cc0bc56ed/8ff5a/6c5ed9f3-f64a-4dfc-9454-9260a072f835.png 240w,\n/static/5497342ce676e8a64b2f559cc0bc56ed/f7a31/6c5ed9f3-f64a-4dfc-9454-9260a072f835.png 458w\"\n        sizes=\"(max-width: 458px) 100vw, 458px\"\n      />\n    </span>\n  </span>\n  \n에러를 발생시킵니다.</p>\n</blockquote>\n<h4>base64로 디코딩한 Session 정보</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1ef052cd5f350f2437dc34bc3026fc722b98ffb1:�}q(Uunscoped_tokenU�gAAAAABgLMgIMtPsvMIBf4vH7kapIzHVaWItsBMFjRb4TAkKgr4rVPUhVXCG6YPkDp5OuRUHlVBcDtPEUv3cpaQgjefoM5Y4zCs__6myyolZ-COyoJaFDKykgQ_F5oo7cN74J9DteTMiQio298r5O-23JeYTfdZWBgqUuser_idX 2d9eb8b0ca4f4abc8bfb74cbf8ae5238qU\nregion_namecdjango.utils.functional\n_lazy_proxy_unpickle\nq(cdjango.utils.translation\nugettext\nqUDefault Region�q}qc__builtin__\nunicode\n_auth_user_idhUregion_endpointXttp://172.16.0.250:5000/v3q\nUservices_regionX       RegionOneq\nU\nusage_startU\n2021-02-16U_auth_user_backendU&amp;openstack_auth.backend.KeystoneBackendU  usage_endU\n2021-02-17Utokencopenstack_auth.user\nToken\nq\n}q(Uunscoped_tokenqhUdomainq}q(UidqNUnameqNuUserviceCatalogq]q(}q(X     endpointsq]q(}q(XurlqXhttp://172.16.0.250:8042X interfaceqXttp://210.207.104.171:8042hXhttp://172.16.0.250:8042hX&lt;http://172.16.0.250:8776/v2/273795270dc5449baf47b1dfbca19170hX?http://210.207.104.171:8776/v2/3b7d443449b64cf89e4d37a20b04a407hX&lt;http://172.16.0.250:8776/v2/273795270dc5449baf47b1dfbca19170hXhttp://172.16.0.250:9292hXhttp://172.16.0.250:9292hXttp://210.207.104.171:9292hX?http://210.207.104.171:8774/v2/3b7d443449b64cf89e4d37a20b04a407hX&lt;http://172.16.0.250:8774/v2/273795270dc5449baf47b1dfbca19170hX&lt;http://172.16.0.250:8774/v2/273795270dc5449baf47b1dfbca19170hXhttp://172.16.0.250:9876hXttp://210.207.104.171:9876hXhttp://172.16.0.250:9876hX&gt;http://172.16.0.250:8774/v2.1/273795270dc5449baf47b1dfbca19170hXAhttp://210.207.104.171:8774/v2.1/3b7d443449b64cf89e4d37a20b04a407hX&gt;http://172.16.0.250:8774/v2.1/273795270dc5449baf47b1dfbca19170hXhttp://172.16.0.250:9696hXhttp://172.16.0.250:9696hXttp://210.207.104.171:9696hXhttp://192.168.140.250:35357hXttp://210.207.104.171:5000hXhttp://172.16.0.250:5000hX?http://210.207.104.171:8004/v1/3b7d443449b64cf89e4d37a20b04a407hX&lt;http://172.16.0.250:8004/v1/273795270dc5449baf47b1dfbca19170hX&lt;http://172.16.0.250:8004/v1/273795270dc5449baf47b1dfbca19170hXttp://210.207.104.171:8041hXhttp://172.16.0.250:8041hXhttp://172.16.0.250:8041hXttp://210.207.104.171:8082hXhttp://172.16.0.250:8082hXhttp://172.16.0.250:8082hXhttp://172.16.0.250:8780hXhttp://172.16.0.250:8780hXttp://210.207.104.171:8780hXhttp://210.207.104.171:8000/v1hXttp://172.16.0.250:8000/v1hXttp://172.16.0.250:8000/v1hX&lt;http://172.16.0.250:8776/v3/273795270dc5449baf47b1dfbca19170hX?http://210.207.104.171:8776/v3/3b7d443449b64cf89e4d37a20b04a407hX&lt;http://172.16.0.250:8776/v3/273795270dc5449baf47b1dfbca19170h&amp;0ciso8601.iso8601\nUtc\nqo)Rqp�RqqU\nis_federatedqr�Uprojectqs}qt(hXhhjangquU     domain_idXdefaultUis_admin_project�hX 273795270dc5449baf47b1dfbca19170qvuUuserqw}qx(Upassword_expires_atNhhhXadminqyuUidqzU�gAAAAABgLMgI5Ms6zzPhNZkJcK1yTR32aIjKYCBeNhA2aIMnc6R4350OFmUP5WmKO83KI45-Uh_mUBMRmHzoTHJ9x-B8kaq_mmS0hEKFzuRXRniDvnavIPLV8BOlRJGuEItrEK-WGWs4XDJ_SunDXgazWKPAipOWZqPTLKP2hgY413HvLi8I86buGyDYnFQP25WRygWu1UHvUtenantq{htubX_session_expiryMU_auth_user_hashU(506d93b80b3981000edb8e3e0552d17645989327u.</code></pre></div>\n<p>base64로 디코딩한 Session 정보를 확인해보면 unscoped_token 값이 저장되어 있는 것을 확인할 수 있습니다.</p>\n<h2>로그아웃</h2>\n<p>로그아웃 역시 Django 인증 시스템을 이용합니다. logout<em>then</em>login() 은 로그아웃 후 다시 로그인 페이지로 이동시키는 <code class=\"language-text\">django.contrib.auth.views</code> 모듈의 함수이며 Session 정보를 데이터베이스에서 삭제합니다. 여기서 중요한 점은, Session에 저장되어 있던 Unscoped 토큰은 무효화 처리하지 않는다는 점입니다. (로그아웃 시 Unscoped 토큰을 무효화한 후 세션 정보를 지우는 것이 아니라 단순히 세션 정보를 DB에서 삭제)</p>\n<h4>horizon/openstack_auth/views.py</h4>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">logout</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> login_url<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token triple-quoted-string string\">\"\"\"Logs out the user if he is logged in. Then redirects to the log-in page.\n\n  :param login_url:\n      Once logged out, defines the URL where to redirect after login\n\n  :param kwargs:\n      see django.contrib.auth.views.logout_then_login extra parameters.\n\n  \"\"\"</span>\n  msg <span class=\"token operator\">=</span> <span class=\"token string\">'Logging out user \"%(username)s\".'</span> <span class=\"token operator\">%</span> \\\n      <span class=\"token punctuation\">{</span><span class=\"token string\">'username'</span><span class=\"token punctuation\">:</span> request<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">}</span>\n  LOG<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span>\n\n  <span class=\"token triple-quoted-string string\">\"\"\" Securely logs a user out. \"\"\"</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>utils<span class=\"token punctuation\">.</span>is_websso_enabled <span class=\"token keyword\">and</span> utils<span class=\"token punctuation\">.</span>is_websso_default_redirect<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span>\n        utils<span class=\"token punctuation\">.</span>get_websso_default_redirect_logout<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    auth_user<span class=\"token punctuation\">.</span>unset_session_user_variables<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> django_http<span class=\"token punctuation\">.</span>HttpResponseRedirect<span class=\"token punctuation\">(</span>\n        utils<span class=\"token punctuation\">.</span>get_websso_default_redirect_logout<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> django_auth_views<span class=\"token punctuation\">.</span>logout_then_login<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span>\n                                                login_url<span class=\"token operator\">=</span>login_url<span class=\"token punctuation\">,</span>\n                                                <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span></code></pre></div>\n<h3>레퍼런스</h3>\n<ul>\n<li><a href=\"https://galid1.tistory.com/207\">https://galid1.tistory.com/207</a></li>\n<li><a href=\"https://docs.djangoproject.com/en/3.1/topics/http/sessions/\">https://docs.djangoproject.com/en/3.1/topics/http/sessions/</a></li>\n<li><a href=\"https://documentation.suse.com/hpe-helion/8/html/hpe-helion-openstack-clm-all/ops-managing-identity.html\">https://documentation.suse.com/hpe-helion/8/html/hpe-helion-openstack-clm-all/ops-managing-identity.html</a></li>\n<li><a href=\"https://zenodo.org/record/34463/files/SummerStudentReport-PawelPamula.pdf?download=1\">https://zenodo.org/record/34463/files/SummerStudentReport-PawelPamula.pdf?download=1</a></li>\n</ul>","fields":{"tagSlugs":["/tags/open-stack/"],"slug":"/posts/how-does-openstack-horizon-authenticate-users/"},"frontmatter":{"title":"OpenStack Horizon은 어떻게 사용자를 인증할까?","tags":["OpenStack"],"date":"2021-02-18T00:00:00.000Z","description":"OpenStack Horizon은 어떻게 사용자를 인증, 인가하고 Keystone과 연동할까요? 이에 대한 과정을 시퀀스 다이어그램과 코드를 통해 알아봅시다."}}},"pageContext":{"slug":"/posts/how-does-openstack-horizon-authenticate-users/"}},"staticQueryHashes":[]}